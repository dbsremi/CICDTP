name: CI/CD - CRUD API vers Cloud Run

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  CLOUD_RUN_SERVICE: crud-api
  DB_INSTANCE_CONNECTION_NAME: ${{ secrets.DB_INSTANCE_CONNECTION_NAME }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  LOKI_URL: ${{ secrets.LOKI_URL }}

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        run: |
          VERSION="${GITHUB_REF_NAME}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "API_IMAGE=${DOCKERHUB_USERNAME}/crud-api:${VERSION}" >> $GITHUB_ENV
          echo "FLUENT_IMAGE=${DOCKERHUB_USERNAME}/crud-fluent-bit:${VERSION}" >> $GITHUB_ENV
          echo "CLOUD_RUN_SA_EMAIL=cloud-run-sa@${GCP_PROJECT_ID}.iam.gserviceaccount.com" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./App
          file: ./App/Dockerfile
          push: true
          tags: |
            ${{ env.API_IMAGE }}
            ${{ env.DOCKERHUB_USERNAME }}/crud-api:latest

      - name: Build and push Fluent Bit image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./App/Dockerfile.fluent-bit
          push: true
          tags: |
            ${{ env.FLUENT_IMAGE }}
            ${{ env.DOCKERHUB_USERNAME }}/crud-fluent-bit:latest

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Install Cloud SQL Proxy (v1)
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy

      - name: Start Cloud SQL Proxy
        run: |
          ./cloud_sql_proxy -instances=${DB_INSTANCE_CONNECTION_NAME}=tcp:3306 &
          sleep 15

      - name: Build migrations image
        run: |
          docker build -f App/Dockerfile.migrations -t crud-migrations:${VERSION} App

      - name: Run DB migrations
        run: |
          docker run --rm \
            --network=host \
            -e DB_HOST=127.0.0.1 \
            -e DB_USER="${DB_USER}" \
            -e DB_PASSWORD="${DB_PASSWORD}" \
            -e DB_NAME="${DB_NAME}" \
            crud-migrations:${VERSION}

      - name: Render Cloud Run manifest
        run: |
          sed -e "s|__API_IMAGE__|${API_IMAGE}|g" \
              -e "s|__FLUENT_IMAGE__|${FLUENT_IMAGE}|g" \
              -e "s|__DB_INSTANCE_CONNECTION_NAME__|${DB_INSTANCE_CONNECTION_NAME}|g" \
              -e "s|__DB_USER__|${DB_USER}|g" \
              -e "s|__DB_PASSWORD__|${DB_PASSWORD}|g" \
              -e "s|__DB_NAME__|${DB_NAME}|g" \
              -e "s|__LOKI_URL__|${LOKI_URL}|g" \
              -e "s|__CLOUD_RUN_SA_EMAIL__|${CLOUD_RUN_SA_EMAIL}|g" \
              cloud-run-service.yaml > rendered-cloud-run.yaml

      - name: Deploy to Cloud Run
        run: |
          gcloud run services replace rendered-cloud-run.yaml \
            --region="${GCP_REGION}" \
            --project="${GCP_PROJECT_ID}"

          gcloud run services add-iam-policy-binding "${CLOUD_RUN_SERVICE}" \
            --region="${GCP_REGION}" \
            --member="allUsers" \
            --role="roles/run.invoker"

